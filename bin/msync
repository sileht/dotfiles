#!/bin/bash

echo "maildir sync"
mbsync -aqq 

echo "notmuch new"
notmuch new -q 2>&1 | grep -v -e 'Ignoring non-mail'

tagif(){
    local dir=$1
    local match=$2
    local tag=$3
    echo $dir | grep -q "$match" ; ret=$?
    if [ $ret -eq 0 ] ; then
        echo "+$tag"
    fi
}

echo "auto tagging"
notmuch tag +telemetry "tag:new and (ceilometer or telemetry or aodh or gnocchi or panko)"
notmuch tag +oslo tag:new and oslo
notmuch tag +inbox "tag:new and (folder:Inbox or tag:unread)"

for dir in $(find ~/.mail/sileht -maxdepth 1 -type d -name ".*" -printf '%f\n'); do
    dir="${dir#\.}"
    tags="+$dir"
    tags="$tags $(tagif $dir 'zml-os' 'openstack')"
    tags="$tags $(tagif $dir 'zml-puppet-openstack' 'openstack')"
    tags="$tags $(tagif $dir 'ttnn' 'ttnn')"
    tags="$tags $(tagif $dir 'perso' 'perso')"
    notmuch tag $tags tag:new and folder:$dir
done
for file in $(notmuch search --output=files tag:new) ; do
    cat "$file" | notmuch_abook.py update
done
notmuch tag -new tag:new

