#!/bin/bash

#set -x

release=$1

valid_release=$(git branch -r | grep  "\<origin/stable/$release\>")
if [ ! "$valid_release" ] ; then
    echo "Release $release is invalid"
    exit 1
fi

branch=$(git rev-parse --abbrev-ref HEAD)
#changeid=$(git show |awk '/Change-Id/{print $2}')

alreadyexist=$(git branch -l | grep $branch-$release)
git fetch origin
if [ "$alreadyexist" ]; then
    git checkout $branch-$release
#    newchangeid=$(git show |awk '/Change-Id/{print $2}')
#    echo "Found previous Change-Id $newchangeid, reuse it."
    git reset --hard origin/stable/$release
else
    git checkout origin/stable/$release -b $branch-$release
fi

git cherry-pick -x $branch

#if [ "$newchangeid" ] ; then
#    GIT_EDITOR="sed -ie '/Change-Id/s/.*/Change-Id: $newchangeid/'" git commit --amend -a
#else
#    GIT_EDITOR="sed -ie '/Change-Id/d'" git commit --amend -a
#fi
#GIT_EDITOR="sed -ie '/Change-Id/a(cherry picked from commit $changeid)'" git commit --amend -a
git-review
git checkout $branch
