#!/usr/bin/python3
# -*- coding: utf-8 -*-
# flake8: noqa: E501
"""Sound controller."""

import functools
import subprocess
import time

import pulsectl


def _bluetooth(*args, timeout=None):
    cmd = ["bluetoothctl"] + list(args)
    return subprocess.run(
        cmd, check=True, stdout=subprocess.PIPE, text=True, timeout=timeout
    ).stdout


def _is_bluetooth_on():
    for line in _bluetooth("show").split("\n"):
        line = line.strip()
        if line == "Powered: yes":
            return True
    return False


def _select_output(pulse, card, profile):
    pulse.card_profile_set(card, profile.name)

    sinks = []
    while not sinks:
        time.sleep(0.1)
        sinks = [
            sink
            for sink in pulse.sink_list()
            if sink.card == card.index
            or sink.name == "auto_null"
            or profile.name == "off"
        ]

    sink_output = sinks[0]
    pulse.default_set(sink_output)
    for sink_input in pulse.sink_input_list():
        pulse.sink_input_move(sink_input.index, sink_output.index)


def _get_bluetooth_device_info(mac):
    info = {}
    for line in _bluetooth("info", mac).split("\n")[1:]:
        name, _, value = line.strip().partition(": ")
        if name == "UUID":
            value = value.split("(")[0].strip()
            info.setdefault(name, []).append(value)
        else:
            info[name] = value
    return info


def _bluetooth_unpair(mac, connected):
    if connected:
        _bluetooth("disconnect", mac)
    _bluetooth("remove", mac)


def _bluetooth_pair(mac):
    _bluetooth("trust", mac)
    _bluetooth("pair", mac)
    _bluetooth("connect", mac)


def _bluetooth_scan():
    try:
        _bluetooth("scan", "on", timeout=3)
    except subprocess.TimeoutExpired:
        pass


def _get_bluetooth_items():
    items = {}
    if _is_bluetooth_on():
        items["    ï–® Bluetooth | Scan (3 seconds)"] = functools.partial(_bluetooth_scan)
        items["    ï–® Bluetooth | Off"] = functools.partial(_bluetooth, "power", "off")
        for line in _bluetooth("devices").split("\n"):
            if not line.strip():
                continue
            mac, _, name = line.strip()[7:].partition(" ")
            info = _get_bluetooth_device_info(mac)
            if info["Paired"] == "yes":
                if "Audio Sink" in info["UUID"]:
                    connected = info["Connected"] == "yes"
                    if connected:
                        label = f"    ðŸŽ§ {info['Name']} | Disconnect"
                        items[label] = functools.partial(_bluetooth, "disconnect", mac)
                    else:
                        label = f"    ðŸŽ§ {info['Name']} | Connect"
                        items[label] = functools.partial(_bluetooth, "connect", mac)
                label = f"    ðŸŽ§ {info['Name']} | Disconnect & Unpair"
                items[label] = functools.partial(_bluetooth_unpair, mac, connected)
            else:
                label = f"    ðŸŽ§ {info['Name']} | Pair & Connect"
                items[label] = functools.partial(_bluetooth_pair, mac)
    else:
        items["    ï–® Bluetooth | On"] = functools.partial(_bluetooth, "power", "on")

    return items


def _get_pulseaudio_cards_profiles(pulse):
    default_sink_name = pulse.server_info().default_sink_name
    default_card_index = [
        sink.card for sink in pulse.sink_list() if sink.name == default_sink_name
    ][0]
    items = {}
    cards = pulse.card_list()
    for card in reversed(cards):
        for profile in reversed(card.profile_list):
            if profile.available:
                status = "   "
                if (
                    card.index == default_card_index
                    and profile.name == card.profile_active.name
                ) or (profile.name == "off" and default_sink_name == "auto_null"):
                    status = "âž¤ "
                if card.proplist["device.icon_name"] == "audio-headphones-bluetooth":
                    icon = "ðŸŽ§"
                else:
                    icon = "ðŸ”Š"
                label = f"{status} {icon} {card.proplist['device.description']} | {profile.description}"
                items[label] = functools.partial(_select_output, pulse, card, profile)
    return items


def main(pulse):
    items = {}

    items.update(_get_pulseaudio_cards_profiles(pulse))
    items["-" * 320] = None
    items.update(_get_bluetooth_items())

    p = subprocess.Popen(
        ["dmenu", "-i", "-l", "30"],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        text=True,
    )
    selected = p.communicate(input="\n".join(items.keys()))[0][:-1]
    if selected:
        callback = items.get(selected)
        if callback:
            callback()
        else:
            print("Selected invalid")
    else:
        print("Nothing selected")


if __name__ == "__main__":
    with pulsectl.Pulse("sound-controller") as pulse:
        main(pulse)
